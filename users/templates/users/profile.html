{% extends "main/base.html" %}
{% load static %}

{% block title %}Profile{% endblock title %}

{% block content %}
    <div class="d-flex flex-column flex-lg-row custom-profile-container ">
        <div class="profile p-3 ">
            <h2>Profile Settings</h2>
            
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <form action="{% url 'users:profile' %}" method='post' enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Общие ошибки формы -->
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="profile-grid">
                    <div class="profile-left">
                        <div class="avatar-section">
                            {% if user.image %}
                                <img src="{{ user.image.url }}" alt="Avatar" class='img-fluid'>
                            {% else %}
                                <img src="{% static 'img/no-image.jpg' %}" alt="Avatar" class='img-fluid'>
                            {% endif %}
                            <input type="file" class='form-control mt-3' id='id_image' name="image" accept="image/*">
                            {% if form.image.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.image.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="profile-right">
                        <div class="form-row">
                            <div class="mb-3">
                                <label for="id_first_name" class='form-label'>First Name</label>
                                <input type="text" class='form-control form-styleprofile' id="id_first_name" 
                                       name="first_name" placeholder="Your First Name" 
                                       value="{{ user.first_name|default:'' }}" required>
                                {% if form.first_name.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.first_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_last_name" class='form-label'>Last Name</label>
                                <input type="text" class='form-control form-styleprofile' id="id_last_name" 
                                       name="last_name" placeholder="Your Last Name" 
                                       value="{{ user.last_name|default:'' }}" required>
                                {% if form.last_name.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.last_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="mb-3">
                                <label for="id_username" class='form-label'>Username</label>
                                <input type="text" class='form-control form-styleprofile' id="id_username" 
                                       name="username" placeholder="Your Username" 
                                       value="{{ user.username|default:'' }}" required>
                                {% if form.username.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.username.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_email" class='form-label'>Email</label>
                                <input type="email" class='form-control form-styleprofile' id="id_email" 
                                       name="email" placeholder="Your Email" 
                                       value="{{ user.email|default:'' }}" required>
                                {% if form.email.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in form.email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="btns">
                    <button type='submit' class='profile-btn'>Save Changes</button>
                    <a class="profile-btn logout-btn" href="{% url 'user:logout' %}">Logout</a>
                </div>
            </form>
        </div>
        
        <div class='orders p-3'>
            <h2>Order History</h2>
            {% if orders %}
                <div class="orders-container">
                    {% for order in orders %}
                        <div class="order-cart">
                            <h5 class='order-title'>Order #{{ order.id }}</h5>
                            <div class="order-items">
                                {% for item in order.items.all %}
                                    <div class="orders-carts">
                                        <span class="desc">Product: </span>
                                        <a href="{% url 'main:product_detail' item.product.slug %}">{{ item.product.name }}</a>
                                        <br>
                                        <span class="desc">Quantity: </span> {{ item.quantity }}
                                        <span class="desc">Price: ${{ item.price }}</span>
                                        <br>
                                        <span class="desc">Date: </span> {{ order.created|date:"M d, Y" }}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-orders">
                    <h3>No Orders Yet</h3>
                    <p>You haven't placed any orders yet. Start shopping now!</p>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock content %}